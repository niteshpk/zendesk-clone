<!DOCTYPE html>
<html>
<head><title>Agent Interface</title></head>
<body>
  <h2>Agent Interface</h2>
  <p>Logged in as: <strong id="agentInfo"></strong></p>
  <button id="logoutBtn">Logout</button>

  <div id="messages" style="border:1px solid black; height:300px; overflow-y:auto; padding:10px;"></div>
  <input id="reply_input" placeholder="Type reply..." style="width:200px;" />
  <button id="reply_btn">Send Reply</button>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    // ✅ Read cookie
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }

    function deleteCookie(name) {
      document.cookie = name + '=; Max-Age=0; path=/';
    }

    let tenantId = getCookie('tenantId');
    let agentUsername = getCookie('agentUsername');

    if (!tenantId || !agentUsername) {
      alert("Session expired. Please login again.");
      window.location.href = '/agent-login';
    }

    // Show agent info
    document.getElementById("agentInfo").innerText = `Agent: ${agentUsername} | Tenant ID: ${tenantId}`;

    document.getElementById('logoutBtn').onclick = () => {
      deleteCookie('tenantId');
      deleteCookie('agentUsername');
      window.location.href = '/agent-login';
    };

    // Load chat history first
    fetch(`/chat-history/${tenantId}`)
      .then(res => res.json())
      .then(history => {
        document.getElementById("messages").innerHTML = "";
        history.forEach(entry => {
          const messageBlock = document.createElement('div');
          if (entry.type === 'client_message') {
            messageBlock.innerHTML = `<p><strong>Client:</strong> ${entry.message}</p>`;
          } else if (entry.type === 'agent_reply') {
            messageBlock.innerHTML = `<p><strong>Agent (${entry.agentUsername}):</strong> ${entry.message}</p>`;
          }
          document.getElementById('messages').appendChild(messageBlock);
        });

        const socket = io();
        socket.emit('join', tenantId);

        // Listen for new client messages
        socket.on('new_message', (data) => {
          if (data.tenantId === tenantId) {
            const msgDiv = document.createElement('div');
            msgDiv.innerHTML = `<p><strong>Client:</strong> ${data.message}</p>`;
            document.getElementById('messages').appendChild(msgDiv);
          }
        });

        // Listen for agent replies (own + other agents)
        socket.on('agent_reply', (data) => {
          if (data.tenantId === tenantId) {
            const replyDiv = document.createElement('div');
            replyDiv.innerHTML = `<p><strong>Agent (${data.agentUsername}):</strong> ${data.message}</p>`;
            document.getElementById('messages').appendChild(replyDiv);
          }
        });

        // When agent sends reply
        document.getElementById('reply_btn').onclick = () => {
          const reply = document.getElementById('reply_input').value.trim();
          if (!reply) return;

          // ❌ Do NOT append message locally here, only emit to server
          socket.emit('reply_message', { tenantId, message: reply, agentUsername });
          document.getElementById('reply_input').value = '';
        };

        document.getElementById('reply_input').addEventListener('keyup', function(event) {
          if (event.key === 'Enter') {
            document.getElementById('reply_btn').click();
          }
        });
      });
  </script>
</body>
</html>
