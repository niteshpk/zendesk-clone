<!DOCTYPE html>
<html>
<head><title>Agent Interface</title></head>
<body>
  <h2>Agent Interface</h2>

  <label for="tenantId">Enter Tenant ID:</label>
  <input type="text" id="tenantIdInput" placeholder="tenant_..." />
  <button id="loadTenantBtn">Load Chat</button>

  <div id="chatSection" style="display:none;">
    <div id="messages" style="border:1px solid black; height:300px; overflow-y:auto; padding:10px;"></div>
    <input id="reply_input" placeholder="Type reply..." style="width:200px;" />
    <button id="reply_btn">Send Reply</button>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    let socket;
    let tenantId;

    document.getElementById('loadTenantBtn').onclick = () => {
      tenantId = document.getElementById('tenantIdInput').value.trim();
      if (!tenantId) return alert("Please enter Tenant ID");

      // Load chat history
      fetch(`http://localhost:3000/chat-history/${tenantId}`)
        .then(res => res.json())
        .then(history => {
          document.getElementById("messages").innerHTML = "";  // clear old messages
          history.forEach(entry => {
            const messageBlock = document.createElement('div');
            if (entry.type === 'client_message') {
              messageBlock.innerHTML = `<p><strong>Client:</strong> ${entry.message}</p>`;
            } else {
              messageBlock.innerHTML = `<p><strong>You:</strong> ${entry.message}</p>`;
            }
            document.getElementById('messages').appendChild(messageBlock);
          });

          document.getElementById("chatSection").style.display = "block";

          // Start WebSocket connection after loading history
          socket = io();
          socket.on('connect', () => {
            socket.emit('join', tenantId);
          });

          socket.on('new_message', (data) => {
            if (data.tenantId === tenantId) {
              const msgDiv = document.createElement('div');
              msgDiv.innerHTML = `<p><strong>Client:</strong> ${data.message}</p>`;
              document.getElementById('messages').appendChild(msgDiv);
            }
          });

          document.getElementById('reply_btn').onclick = () => {
            const reply = document.getElementById('reply_input').value.trim();
            if (!reply) return;
            socket.emit('reply_message', { tenantId, message: reply });

            const replyDiv = document.createElement('div');
            replyDiv.innerHTML = `<p><strong>You:</strong> ${reply}</p>`;
            document.getElementById('messages').appendChild(replyDiv);
            document.getElementById('reply_input').value = '';
          };

          document.getElementById('reply_input').addEventListener('keyup', function(event) {
            if (event.key === 'Enter') {
              document.getElementById('reply_btn').click();
            }
          });
        });
    }
  </script>
</body>
</html>
