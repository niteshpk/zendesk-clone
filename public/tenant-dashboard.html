<!DOCTYPE html>
<html>

<head>
  <title>Tenant Dashboard</title>
  <style>
    table,
    td,
    th {
      border-collapse: collapse;
      padding: 5px
    }
  </style>
</head>

<body>

  <h1>Tenant Dashboard</h1>

  <!-- Navigation -->
  <nav>
    <a href="/tenant-dashboard.html" id="refreshLink">Refresh Dashboard</a> |
    <a href="/tenant-login">Logout</a>
  </nav>

  <hr>
  <div id="tenantInfoBox">
    <p><strong>Business Name:</strong> <span id="businessName"></span></p>
    <p><strong>Email:</strong> <span id="email"></span></p>
    <p><strong>Tenant ID:</strong> <span id="tenantId"></span></p>
  </div>

  <hr>

  <!-- Widget Section -->
  <section>
    <h2>Create Widget</h2>
    <form method="POST" action="/create-widget">
      Widget Title: <input type="text" name="widgetTitle" /><br />
      Welcome Text: <input type="text" name="welcomeText" /><br />
      Logo URL: <input type="text" name="logoUrl" /><br />
      Widget Color (Hex): <input type="text" name="color" /><br />
      <input type="hidden" id="tenantIdInput" name="tenantId" value="" />
      <button type="submit">Save Widget</button>
    </form>

    <hr>

    <h3>Widget Embed Code:</h3>
    <pre id="widgetCode"></pre>
  </section>

  <hr>

  <!-- Agent Section -->
  <section>
    <h2>Agent Management</h2>

    <h3>Existing Agents:</h3>
    <table border="1" id="agentTable">
      <thead>
        <tr>
          <th>Agent ID</th>
          <th>Tenant ID</th>
          <th>Username</th>
          <th>Password</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <hr>
    <h3>Add New Agent:</h3>
    <form method="POST" action="/create-agent">
      Agent Name: <input type="text" name="agentName" /><br />
      Agent Password: <input type="password" name="agentPassword" /><br />
      <input type="hidden" id="tenantIdInput2" name="tenantId" value="" />
      <button type="submit">Create Agent</button>
    </form>
    <hr>
  </section>

  <script>
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }


    window.onload = function () {
      const tenantId = getCookie('tenantId');
      if (!tenantId) {
        alert("Session expired. Please login again.");
        window.location.href = '/tenant-login';
        return;
      }

      document.getElementById("tenantIdInput").value = tenantId;
      document.getElementById("tenantIdInput2").value = tenantId;
      document.getElementById("widgetCode").textContent =
        `<script src="http://localhost:3000/widget.js" data-tenant-id="${tenantId}"></` + "script>";


      fetch(`/tenant-info/${tenantId}`)
        .then(res => res.json())
        .then(tenant => {
          document.getElementById("businessName").innerText = tenant.businessName;
          document.getElementById("email").innerText = tenant.email;
          document.getElementById("tenantId").innerText = tenant.tenantId;
        });

      // Load agent list after dashboard loads
      fetch(`/agent-list/${tenantId}`)
        .then(res => res.json())
        .then(agentList => {
          const tbody = document.querySelector("#agentTable tbody");
          agentList.forEach(agent => {
            const row = tbody.insertRow();
            row.insertCell(0).innerText = agent.agentId;
            row.insertCell(1).innerText = tenantId;
            row.insertCell(2).innerText = agent.username;
            row.insertCell(3).innerText = agent.plainPassword;
          });
        });

      fetch(`/widget-config/${tenantId}`)
        .then(res => res.json())
        .then(config => {
          document.querySelector('[name="widgetTitle"]').value = config.widgetTitle || "";
          document.querySelector('[name="welcomeText"]').value = config.welcomeText || "";
          document.querySelector('[name="logoUrl"]').value = config.logoUrl || "";
          document.querySelector('[name="color"]').value = config.color || "#000000";
        });
    }
  </script>

</body>

</html>