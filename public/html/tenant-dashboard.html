<!-- /public/html/tenant-dashboard.html -->
<!DOCTYPE html>
<html>
<head>
  <title>Tenant Dashboard</title>
  <meta http-equiv="Cache-Control" content="no-store" />
</head>
<body>
  <h1>Tenant Dashboard</h1>
  <button id="logoutBtn">Logout</button>

  <div id="tenantInfoBox">
    <p><strong>Business Name:</strong> <span id="businessName"></span></p>
    <p><strong>Email:</strong> <span id="email"></span></p>
    <p><strong>Tenant ID:</strong> <span id="tenantId"></span></p>
  </div>

  <h2>Widget Config</h2>
  <form method="POST" action="/create-widget">
    Widget Title: <input type="text" name="widgetTitle" /><br/>
    Welcome Text: <input type="text" name="welcomeText" /><br/>
    Logo URL: <input type="text" name="logoUrl" /><br/>
    Widget Color (Hex): <input type="text" name="color" /><br/>
    <input type="hidden" id="tenantIdInput" name="tenantId" value="" />
    <button type="submit">Save Widget</button>
  </form>

  <h2>Agent List:</h2>
  <table border="1" id="agentTable">
    <thead>
      <tr><th>Agent ID</th><th>Username</th><th>Password</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <h2>Add New Agent:</h2>
  <form method="POST" action="/create-agent">
    Agent Name: <input type="text" name="agentName" /><br/>
    Agent Password: <input type="password" name="agentPassword" /><br/>
    <input type="hidden" id="tenantIdInput2" name="tenantId" value="" />
    <button type="submit">Create Agent</button>
  </form>

  <script>
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }

    function deleteCookie(name) {
      document.cookie = name + '=; Max-Age=0; path=/';
    }

    window.onload = function () {
      const tenantId = getCookie('tenantId');
      if (!tenantId) {
        alert("Session expired. Please login again.");
        window.location.href = '/tenant-login';
        return;
      }

      document.getElementById("tenantIdInput").value = tenantId;
      document.getElementById("tenantIdInput2").value = tenantId;

      fetch(`/tenant-info/${tenantId}`)
        .then(res => res.json())
        .then(tenant => {
          document.getElementById("businessName").innerText = tenant.businessName;
          document.getElementById("email").innerText = tenant.email;
          document.getElementById("tenantId").innerText = tenant.tenantId;
        });

      fetch(`/widget-config/${tenantId}`)
        .then(res => res.json())
        .then(config => {
          document.querySelector('[name="widgetTitle"]').value = config.widgetTitle || "";
          document.querySelector('[name="welcomeText"]').value = config.welcomeText || "";
          document.querySelector('[name="logoUrl"]').value = config.logoUrl || "";
          document.querySelector('[name="color"]').value = config.color || "#000000";
        });

      fetch(`/agent-list/${tenantId}`)
        .then(res => res.json())
        .then(agentList => {
          const tbody = document.querySelector("#agentTable tbody");
          agentList.forEach(agent => {
            const row = tbody.insertRow();
            row.insertCell(0).innerText = agent.agentId;
            row.insertCell(1).innerText = agent.username;
            row.insertCell(2).innerText = agent.plainPassword;
          });
        });

      document.getElementById('logoutBtn').onclick = () => {
        deleteCookie('tenantId');
        window.location.href = '/tenant-login';
      };

      window.addEventListener("pageshow", () => {
        if (!getCookie('tenantId')) {
          window.location.href = '/tenant-login';
        }
      });
    }
  </script>
</body>
</html>
